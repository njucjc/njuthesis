#LyX 2.3 created this file. For more info see http://www.lyx.org/
\lyxformat 544
\begin_document
\begin_header
\save_transient_properties true
\origin unavailable
\textclass ../build/thesis
\use_default_options true
\maintain_unincluded_children false
\language english
\language_package none
\inputencoding utf8-plain
\fontencoding global
\font_roman "default" "default"
\font_sans "default" "default"
\font_typewriter "default" "default"
\font_math "auto" "auto"
\font_default_family default
\use_non_tex_fonts false
\font_sc false
\font_osf false
\font_sf_scale 100 100
\font_tt_scale 100 100
\use_microtype false
\use_dash_ligatures true
\graphics default
\default_output_format pdf4
\output_sync 0
\bibtex_command default
\index_command default
\paperfontsize default
\spacing single
\use_hyperref false
\papersize default
\use_geometry false
\use_package amsmath 1
\use_package amssymb 1
\use_package cancel 1
\use_package esint 1
\use_package mathdots 1
\use_package mathtools 1
\use_package mhchem 1
\use_package stackrel 1
\use_package stmaryrd 1
\use_package undertilde 1
\cite_engine basic
\cite_engine_type default
\biblio_style plain
\use_bibtopic false
\use_indices false
\paperorientation portrait
\suppress_date false
\justification true
\use_refstyle 1
\use_minted 0
\index Index
\shortcut idx
\color #008000
\end_index
\secnumdepth 3
\tocdepth 3
\paragraph_separation indent
\paragraph_indentation default
\is_math_indent 0
\math_numbering_side default
\quotes_style english
\dynamic_quotes 0
\papercolumns 1
\papersides 1
\paperpagestyle default
\tracking_changes false
\output_changes false
\html_math_output 0
\html_css_as_file 0
\html_be_strict false
\end_header

\begin_body

\begin_layout Title
Assignment 2: Raft Log Consensus
\end_layout

\begin_layout Author
\begin_inset Tabular
<lyxtabular version="3" rows="2" columns="2">
<features tabularvalignment="middle">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
姓名
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
学号
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" bottomline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
陈锦赐
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" bottomline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
MF1833004
\end_layout

\end_inset
</cell>
</row>
</lyxtabular>

\end_inset


\end_layout

\begin_layout Date
2018年12月07日
\end_layout

\begin_layout Standard
\begin_inset CommandInset toc
LatexCommand tableofcontents

\end_inset


\end_layout

\begin_layout Standard
\begin_inset CommandInset include
LatexCommand input
filename "../build/frontmatter.lyx"

\end_inset


\end_layout

\begin_layout Chapter
实验分析
\end_layout

\begin_layout Section
实验目标
\end_layout

\begin_layout Standard
本此实验的目标是：在给定的实验一“Raft Leader Election”的基础上，继续实现Raft的Log Consensus部分，为了完成这个目标，还需要
对实验一中的Leader Election的算法进行扩充，即完善投票机制，以选取最佳的Leader。
\end_layout

\begin_layout Section
Raft中Log的结构
\end_layout

\begin_layout Standard
如图
\begin_inset CommandInset ref
LatexCommand ref
reference "fig:1.1"
plural "false"
caps "false"
noprefix "false"

\end_inset

所示，一个Log的实体由一个三元组(Index, Term, Command)组成：
\end_layout

\begin_layout Itemize
Index：标识一个Log实体在所有Log中的相对位置（下标）；
\end_layout

\begin_layout Itemize
Term：标识一个Log实体产生时的Leader任期，由于Term值是全局单向递增的，故在一个Log内它的值也是单向递增的；
\end_layout

\begin_layout Itemize
Command：标识一条Log实体中所包含的命令。
\end_layout

\begin_layout Standard
\noindent
\begin_inset Float figure
placement H
wide false
sideways false
status collapsed

\begin_layout Plain Layout
\align center
\begin_inset Graphics
	filename /Users/jim/Downloads/njuthesis/res/log.png
	width 12cm

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
Log示意图
\begin_inset CommandInset label
LatexCommand label
name "fig:1.1"

\end_inset


\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
其中一个(Index, Term)对就唯一确定了一个Log实体，Log必须被持久可靠地保存在磁盘中。
\end_layout

\begin_layout Section
Normal Operation
\begin_inset CommandInset citation
LatexCommand cite
key "key-1"
literal "false"

\end_inset


\end_layout

\begin_layout Standard
在集群正常运转（有且仅有一个Leader）的时候的操作过程（Normal Operation）如下：
\end_layout

\begin_layout Itemize
Client向Leader发送Command请求
\end_layout

\begin_layout Itemize
Leader将来自Client的Command请求存入自己的本地日志中（包含当前Term信息）；
\end_layout

\begin_layout Itemize
Leader向所有Follower并发广播AppendEntries的RPC请求，等待Follower的响应；
\end_layout

\begin_layout Itemize
一旦Leader收到大于半数的响应回复，则Leader认为这条Log实体已经被Commit了，所以开始执行这条Command命令，且通知所有Follower这条
Log实体已被提交；
\end_layout

\begin_layout Itemize
将执行结果返回给Client。
\end_layout

\begin_layout Subsection
Log的一致性
\end_layout

\begin_layout Standard
Raft将会尽可能地保证在同一集群的不同Server间的Log保持相对一致的状态，在最好的情况下，所有的机器上的Log都是相同的，但是，这在现实场景下往往是做不
到的，所以Raft保证的Log一致性如下：
\end_layout

\begin_layout Itemize
(Index, Term)对唯一标识一个Log实体；
\end_layout

\begin_layout Itemize
若个Log实体已被Commit，则在这个Log实体之前的所有实体也一定被Commit了。
\end_layout

\begin_layout Subsection
AppendEntries的一致性检查
\end_layout

\begin_layout Standard
为了保证上一小节说到的Log的一致性，需要添加以下约束条件来对AppendEntries做一致性检查：
\end_layout

\begin_layout Itemize
当Leader向Follower发出AppendEntries的请求时，除了要包含新的Log实体外还需要包含上一个Log实体Term值和Index值
\end_layout

\begin_layout Itemize
当Follower接收到了来自Leader的请求时，需要判断当前的Log中的最后一个实体的Term和Index能否与请求中的上一个Log实体Term值和Inde
x值匹配，匹配则接受，不匹配就拒绝。
\end_layout

\begin_layout Standard
\begin_inset Separator plain
\end_inset


\end_layout

\begin_layout Standard
从这个流程来看，我们可以看出这是一个归纳的过程，即要求接受一个新的Log实体前必须要求前一个实体与之匹配，从而保证了Log的一致性。
\end_layout

\begin_layout Section
Leader变更后的Log一致性保证
\begin_inset CommandInset citation
LatexCommand cite
key "key-1"
literal "false"

\end_inset


\end_layout

\begin_layout Standard
旧的Leader挂掉新的Leader上任后，面临的一个问题是，各个Server的Log状态很可能是不一致的，因为旧Leader可能只完成了部分Server的Lo
g复制就挂掉了，而Raft采取的方式是以Leader的Log为准进行Log的Clean up，最终使得所有Follower的日志与新Leader完全相同。
\end_layout

\begin_layout Subsection
安全性原则
\end_layout

\begin_layout Standard
任何实现了Replicated Logs的系统都必须遵循的基本安全性原则是：所有的Server都必须以相同的顺序执行完全相同的Command，而Raft能保证的
安全性原则如下：
\end_layout

\begin_layout Itemize
Leader永远不会修改自己Log中的实体，只能对Log进行添加操作；
\end_layout

\begin_layout Itemize
只有Leader中的Log实体能被提交，即使某条Log实体在其它Server中过半了，但只要Leader中没有就被能被提交；
\end_layout

\begin_layout Itemize
Log实体中的命名在被Server执行之前，这个Log实体必须处于已提交状态。
\end_layout

\begin_layout Standard
\begin_inset Separator plain
\end_inset


\end_layout

\begin_layout Standard
但仅仅保证上述三条原则并不能保证基本的安全性原则，所以必须增加约束条件如下：
\end_layout

\begin_layout Itemize
对Leader选举增加约束条件：如果一个Candidate的Log中缺少已经提交的Log实体，则不给这个Candidate投票；
\end_layout

\begin_layout Itemize
改变Commited的定义：前文提到Log实体过半存在即可提交，但这是不够的，在某些情况下，即使过半也需要延迟提交，以保证后续的Leader中有这条Log实体。
\end_layout

\begin_layout Subsection
选择最佳的Leader
\end_layout

\begin_layout Standard
即选择Log信息最为“完备”的Candidate作为新Leader，Raft的思路是：
\end_layout

\begin_layout Itemize
优先选择Term大的Candidate；
\end_layout

\begin_layout Itemize
Term相同则比较Log的长度，Log越长越具有权威性。
\end_layout

\begin_layout Subsection
修复Follower的Log
\end_layout

\begin_layout Standard
前面我们提到，新的Leader的一项重要任务就是修复Follower的Log，使得最终所有的Follower中的Log都与Leader保持一致，具体的过程如下：
\end_layout

\begin_layout Itemize
删除Follower中的多余Log实体；
\end_layout

\begin_layout Itemize
用自己的Log实体填充Follower中缺失的Log实体。
\end_layout

\begin_layout Chapter
设计与实现
\end_layout

\begin_layout Section
数据结构
\begin_inset CommandInset citation
LatexCommand cite
key "key-4,key-5,key-6"
literal "false"

\end_inset


\end_layout

\begin_layout Subsection
Raft服务器结构体
\end_layout

\begin_layout Standard
基于实验1中对Raf结构体的定义，完善Raft结构体如表
\begin_inset CommandInset ref
LatexCommand ref
reference "tab:2.1"
plural "false"
caps "false"
noprefix "false"

\end_inset

所示，其中后5个是实验2中新增的字段。
\end_layout

\begin_layout Standard
\begin_inset Float table
placement h
wide false
sideways false
status collapsed

\begin_layout Plain Layout
\align center
\begin_inset Caption Standard

\begin_layout Plain Layout
Raft结构体字段
\begin_inset CommandInset label
LatexCommand label
name "tab:2.1"

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout
\align center
\begin_inset Tabular
<lyxtabular version="3" rows="16" columns="3">
<features tabularvalignment="middle">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\series bold
字段名称
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\series bold
类型
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
描述
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
mu
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
sync.Mutex
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
互斥量，用于同步
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
peers
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
[]*labrpc.ClientEnd
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
集群的中Servers
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
me
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
int
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
当前peer在peers数组中的下标
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
state
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
ServerState
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
当前peer的状态
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
currentTerm
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
int
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Server当前所在的任期
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
votedFor
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
int
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
为候选人投票
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
candidateToFollower
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
chan int
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
通知Candidate变回Follower的channel
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
leaderToFollower
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
chan int
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
通知Leader变回Follower的channel
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
heartbeat
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
chan int
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
发送heartbeat的channel
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
electionTimer
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
*time.Timer
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
选举超时计时器
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
commitIndex
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
int
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
最大的已经被commit的日志的index
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
lastApplied
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
int
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
最大的已经被应用到状态机的index
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
nextIndex
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
[]int
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
每个节点下一次应该接收的日志的index
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
matchIndex
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
[]int
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
每个节点已经复制的日志的最大的索引
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" bottomline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
logs
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" bottomline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
[]LogEntry
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" bottomline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
日志实体集
\end_layout

\end_inset
</cell>
</row>
</lyxtabular>

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Subsection
RequestVoteArgs结构体
\end_layout

\begin_layout Standard
基于实验1中对RequestVoteArgs，完善其结构体如表
\begin_inset CommandInset ref
LatexCommand ref
reference "tab:2.2"
plural "false"
caps "false"
noprefix "false"

\end_inset

所示，其中后2个是实验2中新增的字段。
\end_layout

\begin_layout Standard
\begin_inset Float table
placement h
wide false
sideways false
status collapsed

\begin_layout Plain Layout
\align center
\begin_inset Caption Standard

\begin_layout Plain Layout
RequestVoteArgs结构体字段
\begin_inset CommandInset label
LatexCommand label
name "tab:2.2"

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout
\align center
\begin_inset Tabular
<lyxtabular version="3" rows="5" columns="3">
<features tabularvalignment="middle">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\series bold
字段名称
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\series bold
类型
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
描述
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Term
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
int
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Candidate所在的任期
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
CandidateId
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
int
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Candidate的ID
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
LastLogIndex
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
int
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Candidate最后一条日志的索引
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" bottomline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
LastLogTerm 
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" bottomline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
int
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" bottomline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Candidate最后一条日志的任期
\end_layout

\end_inset
</cell>
</row>
</lyxtabular>

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Subsection
RequestVoteReply结构体
\end_layout

\begin_layout Standard
RequestVoteReply的字段与实验1一致，其结构体如表
\begin_inset CommandInset ref
LatexCommand ref
reference "tab:2.3"
plural "false"
caps "false"
noprefix "false"

\end_inset

所示。
\end_layout

\begin_layout Standard
\begin_inset Float table
placement h
wide false
sideways false
status collapsed

\begin_layout Plain Layout
\align center
\begin_inset Caption Standard

\begin_layout Plain Layout
RequestVoteReply结构体字段
\begin_inset CommandInset label
LatexCommand label
name "tab:2.3"

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout
\align center
\begin_inset Tabular
<lyxtabular version="3" rows="3" columns="3">
<features tabularvalignment="middle">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\series bold
字段名称
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\series bold
类型
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
描述
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Term
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
int
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
当前任期，用于Candidate更新自己的任期
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" bottomline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
VoteGranted
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" bottomline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
bool
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" bottomline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
表示是否为Candidate投票
\end_layout

\end_inset
</cell>
</row>
</lyxtabular>

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Subsection
AppendEntryArgs结构体
\end_layout

\begin_layout Standard
基于实验1中对AppendEntryArgs，完善其结构体如表
\begin_inset CommandInset ref
LatexCommand ref
reference "tab:2.4"
plural "false"
caps "false"
noprefix "false"

\end_inset

所示，其中后4个是实验2中新增的字段。
\end_layout

\begin_layout Standard
\begin_inset Float table
placement h
wide false
sideways false
status collapsed

\begin_layout Plain Layout
\align center
\begin_inset Caption Standard

\begin_layout Plain Layout
AppendEntryArgs结构体字段
\begin_inset CommandInset label
LatexCommand label
name "tab:2.4"

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout
\align center
\begin_inset Tabular
<lyxtabular version="3" rows="7" columns="3">
<features tabularvalignment="middle">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\series bold
字段名称
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\series bold
类型
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
描述
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Term
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
int
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Leader的任期
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
LeaderId
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
int
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Leader节点的ID
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
PervLogIndex
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
int
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
此次添加请求的上一个日志Index
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
PrevLogTerm
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
int
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
此次添加加请求的上一个日志Term
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Entries
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
[]LogEntry
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
要添加的日志
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" bottomline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
LeaderCommit
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" bottomline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
int
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" bottomline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
在Leader中已经Commit的Index
\end_layout

\end_inset
</cell>
</row>
</lyxtabular>

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Subsection
AppendEntryReply结构体
\end_layout

\begin_layout Standard
新增AppendEntryReply结构体，其字段如表
\begin_inset CommandInset ref
LatexCommand ref
reference "tab:2.5"
plural "false"
caps "false"
noprefix "false"

\end_inset

所示。
\end_layout

\begin_layout Standard
\begin_inset Float table
placement h
wide false
sideways false
status collapsed

\begin_layout Plain Layout
\align center
\begin_inset Caption Standard

\begin_layout Plain Layout
AppendEntryReply结构体字段
\begin_inset CommandInset label
LatexCommand label
name "tab:2.5"

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout
\align center
\begin_inset Tabular
<lyxtabular version="3" rows="4" columns="3">
<features tabularvalignment="middle">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\series bold
字段名称
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\series bold
类型
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
描述
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Term
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
int
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
当前的任期
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Success
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
bool
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
上一个日志是否匹配
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" bottomline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
NextIndex
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" bottomline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
int
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" bottomline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
下一个Index
\end_layout

\end_inset
</cell>
</row>
</lyxtabular>

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Subsection
LogEntry结构体
\end_layout

\begin_layout Standard
新增LogEntry结构体，其字段如表
\begin_inset CommandInset ref
LatexCommand ref
reference "tab:2.6"
plural "false"
caps "false"
noprefix "false"

\end_inset

所示。
\end_layout

\begin_layout Standard
\begin_inset Float table
placement h
wide false
sideways false
status open

\begin_layout Plain Layout
\align center
\begin_inset Caption Standard

\begin_layout Plain Layout
LogEntry结构体字段
\begin_inset CommandInset label
LatexCommand label
name "tab:2.6"

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout
\align center
\begin_inset Tabular
<lyxtabular version="3" rows="4" columns="3">
<features tabularvalignment="middle">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\series bold
字段名称
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\series bold
类型
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
描述
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Index
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
int
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
下标索引
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Term
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
bool
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Log实体产生时的任期
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" bottomline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Command
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" bottomline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
interface{}
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" bottomline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
命令
\end_layout

\end_inset
</cell>
</row>
</lyxtabular>

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Section
相关处理函数的实现与完善
\end_layout

\begin_layout Subsection
实现Start函数
\end_layout

\begin_layout Standard
用于Leader将一条命令记录到自己的Log中，实现逻辑如下：
\end_layout

\begin_layout Itemize
若该Server不是Leader，则返回(index, term, false)；
\end_layout

\begin_layout Itemize
若该Server为Leader，用该条命令实例化一个Log实体，并添加到自己的本地Log中，返回(index, term, true)。
\end_layout

\begin_layout Standard
细节见raft.go中的Start()函数实现。
\end_layout

\begin_layout Subsection
完善RequestVote函数
\end_layout

\begin_layout Standard
在实验1的基础上，新增对Log权威性的判断
\begin_inset Foot
status open

\begin_layout Plain Layout
Term的判断已经在实验1中实现。
\end_layout

\end_inset

：
\end_layout

\begin_layout Itemize
Candidate的日志等于或多余接收者的日志，则接收者投票给Candidate，否则拒绝投票。
\end_layout

\begin_layout Subsection
完善AppendEntries RPC处理函数
\end_layout

\begin_layout Standard
实现逻辑如下：
\end_layout

\begin_layout Itemize
收到的Term比当前Term小，拒绝请求，返回false；
\end_layout

\begin_layout Itemize
上一条Log实体相应的Term和Index不匹配，拒绝请求，返回false；
\end_layout

\begin_layout Itemize
存在Index相同但Term不同的Log实体，则删除该位置开始的所有Log实体；
\end_layout

\begin_layout Itemize
添加不存在的Log实体；
\end_layout

\begin_layout Itemize
如果LeaderCommit > CommitIndex，则将CommitIndex设置为LeaderCommit和上一个Log实体Index中较小的一个。
\end_layout

\begin_layout Standard
具体细节见代码。
\end_layout

\begin_layout Subsection
实现persist和readPersist函数
\end_layout

\begin_layout Standard
Persist函数的实现逻辑是将Raft的currentTerm、votedFor以及logs字段保存起来；readPersiste是读取保存信息的过程。具体实
现参见代码的相关函数。
\end_layout

\begin_layout Standard
另外，需要在实验1的代码的合适位置添加persist函数调用，以保存信息，避免信息因Serser宕机而丢失，具体位置见代码。
\end_layout

\begin_layout Subsection
添加Log的一致性处理函数
\end_layout

\begin_layout Standard
当一个Candidate成为一个Leader的时候，需要对集群中的Log进行一致性恢复处理，即对每一个Follower，执行如下逻辑：
\end_layout

\begin_layout Itemize
若Follower的最后一个Log实体的Index >= nextIndex，则发送从NextIndex开始的所有日志条目给Folower；
\end_layout

\begin_layout Itemize
若更新Log成功，则更新相应的Follower的nextIndex和matchIndex；
\end_layout

\begin_layout Itemize

\end_layout

\begin_layout Section
总体框架
\end_layout

\begin_layout Chapter
结果演示与总结
\end_layout

\begin_layout Section
实验环境
\end_layout

\begin_layout Standard
用于本次实验的软硬件环境配置如表
\begin_inset CommandInset ref
LatexCommand ref
reference "tab:3.1"
plural "false"
caps "false"
noprefix "false"

\end_inset

所示，包括CPU型号、主存大小、操作系统版本和JRE版本等信息。
\end_layout

\begin_layout Standard
\begin_inset Float table
placement h
wide false
sideways false
status collapsed

\begin_layout Plain Layout
\align center
\begin_inset Caption Standard

\begin_layout Plain Layout
实验的软硬件配置
\begin_inset CommandInset label
LatexCommand label
name "tab:3.1"

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout
\align center
\begin_inset Tabular
<lyxtabular version="3" rows="5" columns="2">
<features tabularvalignment="middle">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\series bold
类别
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
配置描述
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
CPU型号
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Intel Core i7-7700@3.60GHz
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
主存大小
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
32GB
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
操作系统版本
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
macOS Mojave 10.14.1
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" bottomline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Go版本
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" bottomline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
go1.11.2 darwin/amd64
\end_layout

\end_inset
</cell>
</row>
</lyxtabular>

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Section
结果展示
\end_layout

\begin_layout Standard
\noindent
\begin_inset Float figure
placement H
wide false
sideways false
status collapsed

\begin_layout Plain Layout
\align center
\begin_inset Graphics
	filename /Users/jim/Downloads/njuthesis/res/result.png
	height 10cm

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
运行结果展示
\begin_inset CommandInset label
LatexCommand label
name "fig:3.1"

\end_inset


\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Section
总结
\end_layout

\begin_layout Standard
本次实验主要是在实验1:“Leader Election”的基础上进一步实现分布式一致性算法Raft的“Log Consensus”部分，经过实验1的训练，在本
次实验中对Go语言的运用已经不像刚开始那样生疏。在本次实验中遇到的困难主要是来源于对Raft中Log的一致性算法的理解，因为它从直觉上来看是十分自然的，但在具体
实现上有存在许多细节，如果一不小心错过这些一些细节，就会导致实现上的错误。
\end_layout

\begin_layout Standard
对算法的理解我主要参看了文献
\begin_inset CommandInset citation
LatexCommand cite
key "key-1,key-2,key-3"
literal "false"

\end_inset

，实现上遇到的错误，如某些测试用例不通过的问题，都是在Google或StackOverflow上寻找解决方案，总而言之，本次实验让我收获很多，Debug难是本次
实验的最大障碍之一。
\end_layout

\begin_layout Bibliography
\begin_inset CommandInset bibitem
LatexCommand bibitem
key "key-1"

\end_inset

https://www.jianshu.com/p/10bdc956a305
\end_layout

\begin_layout Bibliography
\begin_inset CommandInset bibitem
LatexCommand bibitem
key "key-2"

\end_inset

http://www.cnblogs.com/hzmark/p/raft.html
\end_layout

\begin_layout Bibliography
\begin_inset CommandInset bibitem
LatexCommand bibitem
key "key-4"

\end_inset

https://github.com/sunhay/mit-6.824-2017
\end_layout

\begin_layout Bibliography
\begin_inset CommandInset bibitem
LatexCommand bibitem
key "key-5"

\end_inset

https://github.com/bin2415
\end_layout

\begin_layout Bibliography
\begin_inset CommandInset bibitem
LatexCommand bibitem
key "key-6"

\end_inset

https://github.com/bysui/mit6.824
\end_layout

\begin_layout Bibliography
\begin_inset CommandInset bibitem
LatexCommand bibitem
key "key-3"

\end_inset

Ongaro, Diego, and John K.
 Ousterhout.
 "In search of an understandable consensus algorithm." USENIX Annual Technical
 Conference.
 2014.
\end_layout

\end_body
\end_document
